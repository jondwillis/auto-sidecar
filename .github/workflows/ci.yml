name: CI/CD

on:
  push:
    branches: [main, develop]
    tags:
      - "v*"
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Format Check
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install linters
        run: |
          brew install swiftlint swift-format

      - name: Run SwiftLint
        run: swiftlint lint --strict || echo "SwiftLint not configured yet"

      - name: Check Swift formatting
        run: swift-format lint --recursive Sources/ || echo "Note swift-format issues found (non-blocking)"

      - name: Run ShellCheck
        run: |
          if command -v shellcheck > /dev/null 2>&1; then
            find . -name "*.sh" -type f | while read -r script; do
              echo "Checking $script..."
              shellcheck "$script" || true
            done
            echo "ShellCheck complete"
          else
            echo "ShellCheck not available, skipping"
          fi

  build-and-test:
    name: Build & Test
    runs-on: macos-26
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          # Use Xcode 16.2 or later (includes Swift 6.1+)
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Build release binary
        run: xcrun --toolchain default swift build -c release

      - name: Run tests
        run: xcrun --toolchain default swift test || echo "No tests configured yet"

      - name: Verify binary
        run: |
          if [ ! -f .build/release/auto-sidecar ]; then
            echo "❌ Binary not found!"
            exit 1
          fi
          echo "✓ Binary built successfully"
          ls -lh .build/release/auto-sidecar
          echo "Binary size: $(du -h .build/release/auto-sidecar | cut -f1)"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: auto-sidecar-${{ github.sha }}
          path: .build/release/auto-sidecar
          retention-days: 30

  release:
    name: Create Release
    runs-on: macos-26
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Build app bundle
        run: xcrun --toolchain default swift package build-app
      
      - name: Create DMG
        run: |
          APP_NAME="Auto Sidecar"
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          DMG_NAME="AutoSidecar-${VERSION}.dmg"
          
          echo "Creating DMG..."
          hdiutil create -volname "${APP_NAME}" -srcfolder "${APP_NAME}.app" -ov -format UDZO "${DMG_NAME}"
          
          echo "✓ DMG created: ${DMG_NAME}"
          ls -lh "${DMG_NAME}"
      
      - name: Package CLI binary (tar.gz)
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          mkdir -p dist
          cp .build/release/auto-sidecar dist/
          cp SidecarLauncher dist/
          cp com.jonwillis.autosidecar.plist dist/
          cp scripts/tools/uninstall.sh dist/
          cp README.md dist/
          cp LICENSE dist/ || echo "LICENSE file not found"
          cd dist
          tar -czf auto-sidecar-${VERSION}-macos.tar.gz *
          mv auto-sidecar-${VERSION}-macos.tar.gz ..
          cd ..
      
      - name: Generate SHA256 checksums
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          shasum -a 256 AutoSidecar-${VERSION}.dmg > AutoSidecar-${VERSION}.dmg.sha256
          shasum -a 256 auto-sidecar-${VERSION}-macos.tar.gz > auto-sidecar-${VERSION}-macos.tar.gz.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            AutoSidecar-${{ steps.get_version.outputs.VERSION }}.dmg
            AutoSidecar-${{ steps.get_version.outputs.VERSION }}.dmg.sha256
            auto-sidecar-${{ steps.get_version.outputs.VERSION }}-macos.tar.gz
            auto-sidecar-${{ steps.get_version.outputs.VERSION }}-macos.tar.gz.sha256
          body: |
            ## Installation Options
            
            ### Option 1: DMG (Recommended for most users)
            1. Download `AutoSidecar-${{ steps.get_version.outputs.VERSION }}.dmg`
            2. Open the DMG and drag "Auto Sidecar.app" to Applications
            3. Launch from Applications and grant Accessibility permissions
            
            ### Option 2: CLI Binary (Advanced users)
            1. Download `auto-sidecar-${{ steps.get_version.outputs.VERSION }}-macos.tar.gz`
            2. Extract and run the installation script
            
            ### Verification
            Use the `.sha256` files to verify downloads:
            ```bash
            shasum -a 256 -c AutoSidecar-${{ steps.get_version.outputs.VERSION }}.dmg.sha256
            ```
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
